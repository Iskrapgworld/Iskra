<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>üî• –ò–°–ö–†–ê: –ë–∏—Ç–≤–∞ TG-–º–∏–Ω–∏ üî•</title>
  <style>
    body { margin: 0; background: #111; color: #fff; font-family: sans-serif; text-align: center;}
    h1 { color: #ffa500; margin: 20px 0 12px 0;}
    #topBar { display: flex; justify-content: space-between; align-items: flex-end; padding: 0 10px; font-size: 18px;}
    #bars {display: flex; flex-direction: column; align-items: flex-start;}
    #barsR {display: flex; flex-direction: column; align-items: flex-end;}
    .bar {height: 16px; border-radius: 8px; margin-bottom: 6px; width: 170px;}
    .hp-bar {background: linear-gradient(90deg, #46e255 70%, #ffe928);}
    .shield-bar {background: linear-gradient(90deg, #62cfff 60%, #2f6bd2);}
    .mana-bar {background: linear-gradient(90deg, #ae8cff, #3c2456);}
    #board {display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; width: 336px; margin: 30px auto 10px auto;}
    .cell { width: 50px; height: 50px; border-radius: 12px; background: #222; font-size: 22px; box-shadow: 0 2px 8px #0004; transition: opacity .5s;}
    .red { background: linear-gradient(135deg, #ff5959 70%, #ca2828 100%);}
    .green { background: linear-gradient(135deg, #7dff93 70%, #19c644 100%);}
    .blue { background: linear-gradient(135deg, #8fd8ff 60%, #215fd8 100%);}
    .purple { background: linear-gradient(135deg, #cdaaff 70%, #574694 100%);}
    .orange { background: linear-gradient(135deg, #ffe290 60%, #c88910 100%);}
    .highlight {box-shadow: 0 0 20px 7px #fff7;}
    .fade {opacity: 0;}
    .enemy-turn #board {pointer-events: none; opacity: 0.3;}
    #battleLog {margin: 12px auto; padding: 7px; font-size: 20px; min-height: 36px;}
    #overlay, #endScreen {position: fixed;top: 0;left: 0;width: 100vw;height: 100vh;background: rgba(12,0,18,0.93);display: flex;flex-direction: column;align-items: center;justify-content: center;z-index: 5;}
    #overlay input {padding: 10px;font-size: 18px;border-radius: 7px;border: none;margin-bottom: 16px;width: 250px;}
    #overlay button, #endScreen button, #lightningButton {padding: 12px 35px; font-size: 20px; border-radius: 13px; border: none; background: #9c4fff; color: #fff; margin-top: 10px;}
    #lightningButton {background: #ffcc00; color: #2b202b; margin-bottom: 0;}
    #lightningButton[disabled] {opacity: 0.5;}
    #endScreen {display:none;}
  </style>
</head>
<body>
  <h1>üî• –ò–°–ö–†–ê: –ë–∏—Ç–≤–∞ TG-–º–∏–Ω–∏ üî•</h1>
  <div id="topBar">
    <div id="bars">
      <div style="margin-bottom:3px;">–í—ã:</div>
      <div>‚ù§Ô∏è <span id="hp">200</span></div>
      <div class="bar hp-bar" id="hpBar"></div>
      <div>üõ° <span id="shield">100</span></div>
      <div class="bar shield-bar" id="shieldBar"></div>
      <div>üîÆ <span id="mana">0</span></div>
      <div class="bar mana-bar" id="manaBar"></div>
    </div>
    <div id="barsR">
      <div style="margin-bottom:3px;">–ú–æ–Ω—Å—Ç—Ä:</div>
      <div>üíÄ <span id="enemyHp">100</span></div>
      <div class="bar hp-bar" id="enemyHpBar"></div>
      <div>üõ° <span id="enemyShield">100</span></div>
      <div class="bar shield-bar" id="enemyShieldBar"></div>
      <div>üîÆ <span id="enemyMana">0</span></div>
      <div class="bar mana-bar" id="enemyManaBar"></div>
    </div>
  </div>
  <button id="lightningButton" style="display:none;margin:16px auto;">‚ö° –ú–æ–ª–Ω–∏—è (20 –º–∞–Ω—ã)</button>
  <div id="battleLog">–ö–æ–º–±–æ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å‚Ä¶</div>
  <div id="board"></div>
  <div id="overlay">
    <h2 style="color:#fff;margin-bottom:10px;">–í—Ö–æ–¥ –≤ –∏–≥—Ä—É</h2>
    <input id="nickname" placeholder="–õ–æ–≥–∏–Ω">
    <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button id="loginBtn">–í–æ–π—Ç–∏</button>
  </div>
  <div id="endScreen">
    <h2 id="endMessage" style="font-size:2em;color:#57ff64;margin-bottom:16px;">–ü–æ–±–µ–¥–∞!</h2>
    <button id="backToMenuBtn">–í –º–µ–Ω—é</button>
  </div>
  <script>
    // === –ù–∞—á–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ===
    let hp = 200, shield = 100, mana = 0;
    let enemyHp = 100, enemyShield = 100, enemyMana = 0;

    // --- UI —ç–ª–µ–º–µ–Ω—Ç—ã
    const hpEl = document.getElementById("hp");
    const shieldEl = document.getElementById("shield");
    const manaEl = document.getElementById("mana");
    const enemyHpEl = document.getElementById("enemyHp");
    const enemyShieldEl = document.getElementById("enemyShield");
    const enemyManaEl = document.getElementById("enemyMana");
    const hpBar = document.getElementById("hpBar");
    const shieldBar = document.getElementById("shieldBar");
    const manaBar = document.getElementById("manaBar");
    const enemyHpBar = document.getElementById("enemyHpBar");
    const enemyShieldBar = document.getElementById("enemyShieldBar");
    const enemyManaBar = document.getElementById("enemyManaBar");
    const board = document.getElementById("board");
    const battleLog = document.getElementById("battleLog");
    const overlay = document.getElementById("overlay");
    const endScreen = document.getElementById("endScreen");
    const endMessage = document.getElementById("endMessage");
    const backToMenuBtn = document.getElementById("backToMenuBtn");
    const lightningBtn = document.getElementById("lightningButton");

    // --- –¶–≤–µ—Ç–∞
    const colors = ['red','green','blue','purple','orange'];

    // --- –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    let grid = [];
    let isPlayerTurn = true;
    let turnTimer, dragging = null, lightningUsed = false;
    let playerName = "";

    // === –í—Ö–æ–¥
    document.getElementById('loginBtn').addEventListener('click', enterGame);
    lightningBtn.onclick = useLightning;

    function enterGame() {
      playerName = document.getElementById('nickname').value || '–ò–≥—Ä–æ–∫';
      overlay.style.display = "none";
      startGame();
    }

    // === –°—Ç–∞—Ä—Ç –±–æ—è
    function startGame() {
      // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
      hp = 200; shield = 100; mana = 0;
      enemyHp = 100; enemyShield = 100; enemyMana = 0;
      isPlayerTurn = true;
      lightningUsed = false;
      updateStats();
      createGridNoCombos();
      endScreen.style.display = "none";
      document.body.classList.remove("enemy-turn");
      battleLog.innerHTML = "–ö–æ–º–±–æ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å‚Ä¶";
      startTurn();
    }

    // === –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    function updateStats() {
      hpEl.textContent = hp; shieldEl.textContent = shield; manaEl.textContent = mana;
      enemyHpEl.textContent = enemyHp; enemyShieldEl.textContent = enemyShield; enemyManaEl.textContent = enemyMana;
      hpBar.style.width = (hp/200*170) + "px";
      shieldBar.style.width = (shield/100*170) + "px";
      manaBar.style.width = (mana/100*170) + "px";
      enemyHpBar.style.width = (enemyHp/100*170) + "px";
      enemyShieldBar.style.width = (enemyShield/100*170) + "px";
      enemyManaBar.style.width = (enemyMana/100*170) + "px";
      lightningBtn.style.display = (isPlayerTurn && mana>=20 && !lightningUsed) ? "block":"none";
      lightningBtn.disabled = !(isPlayerTurn && mana>=20 && !lightningUsed);
    }

    // === –ü–æ–ª–µ –ë–ï–ó —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –∫–æ–º–±–æ ===
    function createGridNoCombos() {
      do {
        board.innerHTML = "";
        grid = [];
        for (let i = 0; i < 36; i++) {
          const cell = document.createElement("div");
          cell.className = "cell " + colors[Math.floor(Math.random() * colors.length)];
          board.appendChild(cell);
          grid.push(cell);
        }
      } while(checkMatches().length > 0);
    }

    // === –ë–û–ï–í–ê–Ø –ú–ï–•–ê–ù–ò–ö–ê –° –ö–ê–°–ö–ê–î–ê–ú–ò –ò –ë–û–ù–£–°–ê–ú–ò ===
    function startTurn() {
      isPlayerTurn = true;
      lightningUsed = false;
      document.body.classList.remove("enemy-turn");
      board.style.pointerEvents = "auto";
      updateStats();
      turnTimer = setTimeout(() => {
        board.style.pointerEvents = "none";
        resolveCascade();
      }, 20000); // 20 —Å–µ–∫
    }

    function monsterTurn() {
      isPlayerTurn = false;
      document.body.classList.add("enemy-turn");
      lightningUsed = false;
      lightningBtn.style.display = "none";
      setTimeout(() => {
        let moved = false;
        for (let i = 0; i < 36 && !moved; i++) {
          for (let j = i + 1; j < 36 && !moved; j++) {
            [grid[i].className, grid[j].className] = [grid[j].className, grid[i].className];
            if (checkMatches().length > 0) {
              moved = true;
              setTimeout(() => resolveCascade(), 400);
            } else {
              [grid[j].className, grid[i].className] = [grid[i].className, grid[j].className];
            }
          }
        }
        if (!moved) setTimeout(startTurn, 900);
      }, 700 + Math.random()*600);
    }

    // –ö–ê–°–ö–ê–î: —Å–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –∫–æ–º–±–æ (–æ—Å–Ω–æ–≤–Ω—ã–µ + –≤—ã–ø–∞–≤—à–∏–µ) –∏ —Å—É–º–º–∏—Ä—É–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç—ã
    function resolveCascade() {
      let totalCombos = 0;
      let red = 0, green = 0, blue = 0, purple = 0, orange = 0;
      function processCascade(next) {
        let matches = checkMatches();
        if (!matches.length) return next();
        totalCombos += matches.length;
        matches.forEach(g=>{
          let color = getColor(grid[g[0]]);
          let count = g.length;
          if (color==="red") red += count;
          if (color==="green") green += count;
          if (color==="blue") blue += count;
          if (color==="purple") purple += count;
          if (color==="orange") orange += count;
          g.forEach(i=>grid[i].classList.add('highlight'));
        });
        setTimeout(()=>{
          matches.flat().forEach(i=>{
            grid[i].classList.remove("highlight");
            grid[i].classList.add("fade");
          });
          setTimeout(()=>{
            matches.flat().forEach(i=>grid[i].className = "cell");
            dropDown();
            setTimeout(()=>processCascade(next), 350);
          }, 600);
        }, 1100);
      }
      processCascade(()=>{
        setTimeout(()=>applyEffects({red,green,blue,purple,orange,totalCombos}), 500);
      });
    }

    // –≠—Ñ—Ñ–µ–∫—Ç—ã –ø–æ –≤—Å–µ–º –∫–æ–º–±–æ + –±–æ–Ω—É—Å –∑–∞ –∫–æ–ª-–≤–æ –∫–æ–º–±–æ
    function applyEffects(cs) {
      let {red, green, blue, purple, orange, totalCombos} = cs;
      // –û—Å–Ω–æ–≤–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ –∑–∞ –≤—Å—ë –∫–∞—Å–∫–∞–¥–∏—Ä–æ–≤–∞–Ω–∏–µ)
      let dmg = 0, heal = 0, def = 0, manaGain = 0;
      // –£–†–û–ù, –õ–ï–ß–ï–ù–ò–ï –∏ —Ç.–¥. ‚Äî –ø–æ —Å—É–º–º–µ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ (—Å —É—á–µ—Ç–æ–º 5+)
      if (red>=5) dmg+=20; else if(red>=3) dmg+=10;
      if (green>=5) heal+=10; else if(green>=3) heal+=5;
      if (blue>=5) def+=10; else if(blue>=3) def+=5;
      if (purple>=5) manaGain+=20; else if(purple>=3) manaGain+=10;
      // –ë–û–ù–£–° –∑–∞ –ö–ê–ñ–î–û–ï –∫–æ–º–±–æ: +5% —É—Ä–æ–Ω–∞ –∑–∞ –∫–æ–º–±–æ (–≤–∫–ª—é—á–∞—è –∫–∞—Å–∫–∞–¥—ã)
      let comboBonus = 1 + (totalCombos-1)*0.05; // 2 –∫–æ–º–±–æ = +5%, 3 = +10% –∏ —Ç.–¥.
      if (totalCombos > 1) dmg = Math.round(dmg*comboBonus);

      let logMsg = '';
      if (isPlayerTurn) {
        mana += manaGain; if(mana>100)mana=100;
        let realDmg = dmg;
        if (lightningUsed) { realDmg += 50; logMsg += "‚ö° +–ú–æ–ª–Ω–∏—è! "; mana -= 20; if(mana<0)mana=0;}
        // –¥–µ–ª–∏–º —É—Ä–æ–Ω –º–µ–∂–¥—É —â–∏—Ç–æ–º –∏ —Ö–ø
        let half = Math.floor(realDmg/2);
        if(enemyShield>=half){enemyShield-=half;enemyHp-=(realDmg-half);}
        else{let rem=half-enemyShield;enemyShield=0;enemyHp-=(realDmg-half+rem);}
        shield+=def; if(shield>100)shield=100;
        hp+=heal; if(hp>200)hp=200;
        if(enemyHp<0)enemyHp=0;
        logMsg += `<span style="color:#66ff66;">–ö–æ–º–±–æ √ó${totalCombos}, –£—Ä–æ–Ω: ${realDmg}, –õ–µ—á–µ–Ω–∏–µ: ${heal}, –©–∏—Ç: ${def}, –ú–∞–Ω–∞: ${manaGain}</span>`;
      } else {
        enemyMana += manaGain; if(enemyMana>100)enemyMana=100;
        let realDmg = dmg;
        let half = Math.floor(realDmg/2);
        if(shield>=half){shield-=half;hp-=(realDmg-half);}
        else{let rem=half-shield;shield=0;hp-=(realDmg-half+rem);}
        enemyShield+=def; if(enemyShield>100)enemyShield=100;
        enemyHp+=heal; if(enemyHp>100)enemyHp=100;
        if(hp<0)hp=0;
        logMsg += `<span style="color:#ff3333;">–ö–æ–º–±–æ √ó${totalCombos}, –£—Ä–æ–Ω: ${realDmg}, –õ–µ—á–µ–Ω–∏–µ: ${heal}, –©–∏—Ç: ${def}, –ú–∞–Ω–∞: ${manaGain}</span>`;
      }
      battleLog.innerHTML = logMsg;
      updateStats();
      if (checkEnd()) return;
      isPlayerTurn ? setTimeout(monsterTurn, 850) : setTimeout(startTurn, 900);
    }

    function useLightning() {
      if (mana>=20 && isPlayerTurn && !lightningUsed) {
        lightningUsed = true;
        updateStats();
        lightningBtn.style.display = "none";
      }
    }

    // === –ü–æ–±–µ–¥–∞/–ü–æ—Ä–∞–∂–µ–Ω–∏–µ ===
    function checkEnd() {
      if(hp<=0){
        endMessage.textContent = "–ü–æ—Ä–∞–∂–µ–Ω–∏–µ!";
        endScreen.style.display="flex";
        return true;
      }
      if(enemyHp<=0){
        endMessage.textContent = "–ü–æ–±–µ–¥–∞!";
        endScreen.style.display="flex";
        return true;
      }
      return false;
    }

    // === –î–≤–∏–∂–µ–Ω–∏–µ –∏ —Å–±–æ—Ä ===
