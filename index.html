<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>üî• –ò–°–ö–†–ê: –ë–∏—Ç–≤–∞ TG-–º–∏–Ω–∏ üî•</title>
  <style>
    body { margin: 0; background: #111; color: #fff; font-family: sans-serif; text-align: center;}
    h1 { color: #ffa500; margin: 20px 0 12px 0;}
    #topBar { display: flex; justify-content: space-between; align-items: flex-end; padding: 0 10px; font-size: 18px;}
    #bars {display: flex; flex-direction: column; align-items: flex-start;}
    #barsR {display: flex; flex-direction: column; align-items: flex-end;}
    .bar {height: 16px; border-radius: 8px; margin-bottom: 6px; width: 170px;}
    .hp-bar {background: linear-gradient(90deg, #46e255 70%, #ffe928);}
    .shield-bar {background: linear-gradient(90deg, #62cfff 60%, #2f6bd2);}
    .mana-bar {background: linear-gradient(90deg, #ae8cff, #3c2456);}
    #board {display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; width: 336px; margin: 30px auto 10px auto;}
    .cell { width: 50px; height: 50px; border-radius: 12px; background: #222; font-size: 22px; box-shadow: 0 2px 8px #0004; transition: opacity .5s;}
    .red { background: linear-gradient(135deg, #ff5959 70%, #ca2828 100%);}
    .green { background: linear-gradient(135deg, #7dff93 70%, #19c644 100%);}
    .blue { background: linear-gradient(135deg, #8fd8ff 60%, #215fd8 100%);}
    .purple { background: linear-gradient(135deg, #cdaaff 70%, #574694 100%);}
    .orange { background: linear-gradient(135deg, #ffe290 60%, #c88910 100%);}
    .highlight {box-shadow: 0 0 20px 7px #fff7;}
    .fade {opacity: 0;}
    .enemy-turn #board {pointer-events: none; opacity: 0.3;}
    #battleLog {margin: 12px auto; padding: 7px; font-size: 20px; min-height: 36px;}
    #overlay, #endScreen {position: fixed;top: 0;left: 0;width: 100vw;height: 100vh;background: rgba(12,0,18,0.93);display: flex;flex-direction: column;align-items: center;justify-content: center;z-index: 5;}
    #overlay input {padding: 10px;font-size: 18px;border-radius: 7px;border: none;margin-bottom: 16px;width: 250px;}
    #overlay button, #endScreen button {padding: 12px 35px; font-size: 20px; border-radius: 13px; border: none; background: #9c4fff; color: #fff; margin-top: 10px;}
    #endScreen {display:none;}
  </style>
</head>
<body>
  <h1>üî• –ò–°–ö–†–ê: –ë–∏—Ç–≤–∞ TG-–º–∏–Ω–∏ üî•</h1>
  <div id="topBar">
    <div id="bars">
      <div style="margin-bottom:3px;">–í—ã:</div>
      <div>‚ù§Ô∏è <span id="hp">200</span></div>
      <div class="bar hp-bar" id="hpBar"></div>
      <div>üõ° <span id="shield">100</span></div>
      <div class="bar shield-bar" id="shieldBar"></div>
      <div>üîÆ <span id="mana">0</span></div>
      <div class="bar mana-bar" id="manaBar"></div>
    </div>
    <div id="barsR">
      <div style="margin-bottom:3px;">–ú–æ–Ω—Å—Ç—Ä:</div>
      <div>üíÄ <span id="enemyHp">100</span></div>
      <div class="bar hp-bar" id="enemyHpBar"></div>
      <div>üõ° <span id="enemyShield">100</span></div>
      <div class="bar shield-bar" id="enemyShieldBar"></div>
      <div>üîÆ <span id="enemyMana">0</span></div>
      <div class="bar mana-bar" id="enemyManaBar"></div>
    </div>
  </div>
  <div id="battleLog">–ö–æ–º–±–æ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å‚Ä¶</div>
  <div id="board"></div>
  <div id="overlay">
    <h2 style="color:#fff;margin-bottom:10px;">–í—Ö–æ–¥ –≤ –∏–≥—Ä—É</h2>
    <input id="nickname" placeholder="–õ–æ–≥–∏–Ω">
    <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button id="loginBtn">–í–æ–π—Ç–∏</button>
  </div>
  <div id="endScreen">
    <h2 id="endMessage" style="font-size:2em;color:#57ff64;margin-bottom:16px;">–ü–æ–±–µ–¥–∞!</h2>
    <button id="backToMenuBtn">–í –º–µ–Ω—é</button>
  </div>
  <script>
    // === –ù–∞—á–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ===
    let hp = 200, shield = 100, mana = 0;
    let enemyHp = 100, enemyShield = 100, enemyMana = 0;

    // --- UI —ç–ª–µ–º–µ–Ω—Ç—ã
    const hpEl = document.getElementById("hp");
    const shieldEl = document.getElementById("shield");
    const manaEl = document.getElementById("mana");
    const enemyHpEl = document.getElementById("enemyHp");
    const enemyShieldEl = document.getElementById("enemyShield");
    const enemyManaEl = document.getElementById("enemyMana");
    const hpBar = document.getElementById("hpBar");
    const shieldBar = document.getElementById("shieldBar");
    const manaBar = document.getElementById("manaBar");
    const enemyHpBar = document.getElementById("enemyHpBar");
    const enemyShieldBar = document.getElementById("enemyShieldBar");
    const enemyManaBar = document.getElementById("enemyManaBar");
    const board = document.getElementById("board");
    const battleLog = document.getElementById("battleLog");
    const overlay = document.getElementById("overlay");
    const endScreen = document.getElementById("endScreen");
    const endMessage = document.getElementById("endMessage");
    const backToMenuBtn = document.getElementById("backToMenuBtn");

    // --- –¶–≤–µ—Ç–∞
    const colors = ['red','green','blue','purple','orange'];

    // --- –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    let grid = [];
    let isPlayerTurn = true;
    let turnTimer, dragging = null, lightningUsed = false;
    let playerName = "";

    // === –í—Ö–æ–¥
    document.getElementById('loginBtn').addEventListener('click', enterGame);

    function enterGame() {
      playerName = document.getElementById('nickname').value || '–ò–≥—Ä–æ–∫';
      overlay.style.display = "none";
      startGame();
    }

    // === –°—Ç–∞—Ä—Ç –±–æ—è
    function startGame() {
      // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
      hp = 200; shield = 100; mana = 0;
      enemyHp = 100; enemyShield = 100; enemyMana = 0;
      isPlayerTurn = true;
      lightningUsed = false;
      updateStats();
      createGridNoCombos();
      endScreen.style.display = "none";
      document.body.classList.remove("enemy-turn");
      startTurn();
    }

    // === –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    function updateStats() {
      hpEl.textContent = hp; shieldEl.textContent = shield; manaEl.textContent = mana;
      enemyHpEl.textContent = enemyHp; enemyShieldEl.textContent = enemyShield; enemyManaEl.textContent = enemyMana;
      hpBar.style.width = (hp/200*170) + "px";
      shieldBar.style.width = (shield/100*170) + "px";
      manaBar.style.width = (mana/100*170) + "px";
      enemyHpBar.style.width = (enemyHp/100*170) + "px";
      enemyShieldBar.style.width = (enemyShield/100*170) + "px";
      enemyManaBar.style.width = (enemyMana/100*170) + "px";
    }

    // === –ü–æ–ª–µ –ë–ï–ó —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –∫–æ–º–±–æ ===
    function createGridNoCombos() {
      do {
        board.innerHTML = "";
        grid = [];
        for (let i = 0; i < 36; i++) {
          const cell = document.createElement("div");
          cell.className = "cell " + colors[Math.floor(Math.random() * colors.length)];
          board.appendChild(cell);
          grid.push(cell);
        }
      } while(checkMatches().length > 0);
    }

    // === –õ–æ–≥–∏–∫–∞ –±–æ—è ===
    function startTurn() {
      isPlayerTurn = true;
      lightningUsed = false;
      document.body.classList.remove("enemy-turn");
      board.style.pointerEvents = "auto";
      turnTimer = setTimeout(() => {
        board.style.pointerEvents = "none";
        resolveCascade();
      }, 20000); // 20 —Å–µ–∫
    }

    // --- –õ–æ–≥–∏–∫–∞ –º–æ–Ω—Å—Ç—Ä–∞ ---
    function monsterTurn() {
      isPlayerTurn = false;
      document.body.classList.add("enemy-turn");
      setTimeout(() => {
        let moved = false;
        for (let i = 0; i < 36 && !moved; i++) {
          for (let j = i + 1; j < 36 && !moved; j++) {
            [grid[i].className, grid[j].className] = [grid[j].className, grid[i].className];
            if (checkMatches().length > 0) {
              moved = true;
              setTimeout(() => resolveCascade(), 400);
            } else {
              [grid[j].className, grid[i].className] = [grid[i].className, grid[j].className];
            }
          }
        }
        if (!moved) setTimeout(startTurn, 900);
      }, 700 + Math.random()*600);
    }

    // === –û—Å–Ω–æ–≤–Ω–∞—è –ö–ê–°–ö–ê–î–ù–ê–Ø –ª–æ–≥–∏–∫–∞ ===
    function resolveCascade() {
      let allCombos = [];
      let comboStats = {red:0,green:0,blue:0,purple:0,orange:0, count:0};
      function gatherCombos() {
        let matches = checkMatches();
        if (matches.length === 0) return;
        comboStats.count += matches.length;
        matches.forEach(g=>{
          const color = getColor(grid[g[0]]);
          comboStats[color] += g.length;
          g.forEach(i=>grid[i].classList.add('highlight'));
        });
        setTimeout(()=>{
          matches.flat().forEach(i=>{
            grid[i].classList.remove("highlight");
            grid[i].classList.add("fade");
          });
          setTimeout(()=>{
            matches.flat().forEach(i=>grid[i].className = "cell");
            dropDown();
            setTimeout(gatherCombos, 450);
          }, 500);
        }, 1200);
      }
      gatherCombos();
      setTimeout(()=>applyEffects(comboStats), 2600); // –ø–æ—Å–ª–µ –∫–∞—Å–∫–∞–¥–∞
    }

    // === –†–∞—Å—á—ë—Ç —É—Ä–æ–Ω–∞ –∏ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –ø–æ –í–°–ï–ú –∫–æ–º–±–æ ===
    function applyEffects(cs) {
      // cs ‚Äî comboStats —Å –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–º–∏ –≤—Å–µ–º–∏ —Ü–≤–µ—Ç–∞–º–∏ –∏ –∫–æ–ª-–≤–æ–º –∫–æ–º–±–æ
      let dmg = 0, heal = 0, def = 0, manaGain = 0;
      if (cs.red>=5) dmg+=20; else if(cs.red>=3) dmg+=10;
      if (cs.green>=5) heal+=10; else if(cs.green>=3) heal+=5;
      if (cs.blue>=5) def+=10; else if(cs.blue>=3) def+=5;
      if (cs.purple>=5) manaGain+=20; else if(cs.purple>=3) manaGain+=10;
      if (isPlayerTurn) {
        mana += manaGain; if(mana>100)mana=100;
        let realDmg = dmg;
        // –¥–µ–ª–∏–º —É—Ä–æ–Ω –º–µ–∂–¥—É —â–∏—Ç–æ–º –∏ —Ö–ø
        let half = Math.floor(realDmg/2);
        if(enemyShield>=half){enemyShield-=half;enemyHp-=(realDmg-half);}
        else{let rem=half-enemyShield;enemyShield=0;enemyHp-=(realDmg-half+rem);}
        shield+=def; if(shield>100)shield=100;
        hp+=heal; if(hp>200)hp=200;
        if(enemyHp<0)enemyHp=0;
        battleLog.innerHTML = cs.count
          ? `<span style="color:#66ff66;">–ö–æ–º–±–æ √ó${cs.count}, –£—Ä–æ–Ω: ${dmg}, –õ–µ—á–µ–Ω–∏–µ: ${heal}, –©–∏—Ç: ${def}, –ú–∞–Ω–∞: ${manaGain}</span>`
          : "<span style='color:#fff;'>–ù–µ—Ç –∫–æ–º–±–æ!</span>";
      } else {
        enemyMana += manaGain; if(enemyMana>100)enemyMana=100;
        let realDmg = dmg;
        let half = Math.floor(realDmg/2);
        if(shield>=half){shield-=half;hp-=(realDmg-half);}
        else{let rem=half-shield;shield=0;hp-=(realDmg-half+rem);}
        enemyShield+=def; if(enemyShield>100)enemyShield=100;
        enemyHp+=heal; if(enemyHp>100)enemyHp=100;
        if(hp<0)hp=0;
        battleLog.innerHTML = cs.count
          ? `<span style="color:#ff3333;">–ö–æ–º–±–æ √ó${cs.count}, –£—Ä–æ–Ω: ${dmg}, –õ–µ—á–µ–Ω–∏–µ: ${heal}, –©–∏—Ç: ${def}, –ú–∞–Ω–∞: ${manaGain}</span>`
          : "<span style='color:#fff;'>–ù–µ—Ç –∫–æ–º–±–æ!</span>";
      }
      updateStats();
      checkEnd();
      if (hp<=0||enemyHp<=0) return;
      isPlayerTurn ? setTimeout(monsterTurn, 800) : setTimeout(startTurn, 900);
    }

    // === –ü–æ–±–µ–¥–∞/–ü–æ—Ä–∞–∂–µ–Ω–∏–µ ===
    function checkEnd() {
      if(hp<=0){
        endMessage.textContent = "–ü–æ—Ä–∞–∂–µ–Ω–∏–µ!";
        endScreen.style.display="flex";
        return true;
      }
      if(enemyHp<=0){
        endMessage.textContent = "–ü–æ–±–µ–¥–∞!";
        endScreen.style.display="flex";
        return true;
      }
      return false;
    }

    // === –î–≤–∏–∂–µ–Ω–∏–µ –∏ —Å–±–æ—Ä ===
    function dropDown() {
      for (let c=0;c<6;c++){
        for(let r=5;r>0;r--){
          let i=r*6+c;
          if(!getColor(grid[i])){
            for(let k=r-1;k>=0;k--){
              let up=k*6+c;
              if(getColor(grid[up])){
                grid[i].className = grid[up].className;
                grid[up].className="cell";
                break;
              }
            }
          }
        }
        for(let r=0;r<6;r++){
          let i=r*6+c;
          if(!getColor(grid[i])){
            const cls = colors[Math.floor(Math.random()*colors.length)];
            grid[i].className = "cell "+cls;
          }
        }
      }
    }
    function checkMatches() {
      const matches=[];
      for(let r=0;r<6;r++){
        for(let c=0;c<4;c++){
          let i=r*6+c;
          let a=grid[i],b=grid[i+1],c_=grid[i+2];
          if(getColor(a)&&getColor(a)===getColor(b)&&getColor(b)===getColor(c_))
            matches.push([i,i+1,i+2]);
        }
      }
      for(let c=0;c<6;c++){
        for(let r=0;r<4;r++){
          let i=r*6+c;
          let a=grid[i],b=grid[i+6],c_=grid[i+12];
          if(getColor(a)&&getColor(a)===getColor(b)&&getColor(b)===getColor(c_))
            matches.push([i,i+6,i+12]);
        }
      }
      return matches;
    }
    function getColor(el) {return colors.find(c=>el.classList.contains(c));}

    // === –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö ===
    board.addEventListener("touchstart", e=>{
      const t=e.touches[0],el=document.elementFromPoint(t.clientX,t.clientY);
      if(el&&el.classList.contains("cell")) dragging=el;
    });
    board.addEventListener("touchmove", e=>{
      if(!dragging)return;
      const t=e.touches[0],el=document.elementFromPoint(t.clientX,t.clientY);
      if(el&&el.classList.contains("cell")&&el!==dragging){
        [dragging.className,el.className]=[el.className,dragging.className];
        dragging=el;
      }
    });
    board.addEventListener("touchend", ()=>{
      dragging=null; clearTimeout(turnTimer); board.style.pointerEvents="none"; resolveCascade();
    });

    // === –ö–Ω–æ–ø–∫–∞ "–í –º–µ–Ω—é" ===
    backToMenuBtn.onclick = function() {
      endScreen.style.display = "none";
      overlay.style.display = "flex";
    }
  </script>
</body
