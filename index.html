<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ò–°–ö–†–ê: –ë–∏—Ç–≤–∞</title>
  <style>
    body {
      margin: 0;
      background: #000 url('https://i.imgur.com/lkA1J8k.png') repeat; /* –ü–∏–∫—Å–µ–ª—å–Ω—ã–π —Ç—ë–º–Ω—ã–π —Ñ–æ–Ω */
      font-family: sans-serif;
      color: #ffc;
      text-align: center;
    }
    #game {
      margin: auto;
      max-width: 400px;
    }
    h1 {
      margin: 10px 0;
      font-size: 20px;
    }
    #players {
      display: flex;
      justify-content: space-between;
      margin: 0 10px;
    }
    #board {
      display: grid;
      grid-template-columns: repeat(6, 50px);
      grid-template-rows: repeat(6, 50px);
      gap: 2px;
      margin: 10px auto;
    }
    .cell {
      width: 50px;
      height: 50px;
      image-rendering: pixelated;
      background-size: cover;
      transition: opacity 1s ease-in-out;
    }
    .highlight {
      box-shadow: 0 0 10px 2px yellow;
    }
    .fade-out {
      opacity: 0;
    }
    .timer-bar {
      height: 8px;
      background: orange;
      transition: width 0.2s linear;
      margin: 5px 10px;
    }
  </style>
</head>
<body>
  <div id="game">
    <h1>üî• –ò–°–ö–†–ê: PvP-–ö—Ä–∏—Å—Ç–∞–ª–ª—ã üî•</h1>
    <div id="players">
      <div>–ò–≥—Ä–æ–∫ 1: <span id="hp1">1000</span> ‚ù§Ô∏è</div>
      <div>–ò–≥—Ä–æ–∫ 2: <span id="hp2">1000</span> ‚ù§Ô∏è</div>
    </div>
    <div class="timer-bar" id="timer"></div>
    <div id="board"></div>
    <p id="log"></p>
  </div>
  <script>
    const board = document.getElementById("board");
    const log = document.getElementById("log");
    const hp1 = document.getElementById("hp1");
    const hp2 = document.getElementById("hp2");
    const timerBar = document.getElementById("timer");
    const width = 6;
    const height = 6;
    const types = ['attack', 'shield', 'heal', 'crit', 'critdmg', 'magic'];
    const images = {
      attack: 'https://i.imgur.com/xMWrg8K.png',
      shield: 'https://i.imgur.com/I1wGQXM.png',
      heal: 'https://i.imgur.com/lS7ZLgW.png',
      crit: 'https://i.imgur.com/fMEAsrR.png',
      critdmg:'https://i.imgur.com/OlmkQQe.png',
      magic: 'https://i.imgur.com/dDFtqDN.png'
    };
    let grid = [], selected = null, turn = 1;
    let hp = [1000, 1000];
    let timer, timeLeft = 20;
    function startGame() {
      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          createCell(x, y, randomType());
        }
      }
      startTimer();
    }
    function createCell(x, y, type) {
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.x = x;
      cell.dataset.y = y;
      cell.dataset.type = type;
      cell.style.backgroundImage = `url(${images[type]})`;
      cell.addEventListener("touchstart", touchStart, { passive: true });
      cell.addEventListener("touchend", touchEnd);
      board.appendChild(cell);
      grid[y * width + x] = cell;
    }
    let dragStart = null;
    function touchStart(e) {
      dragStart = e.target;
    }
    function touchEnd(e) {
      if (!dragStart) return;
      const target = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
      if (!target || !target.classList.contains("cell")) return;
      swapCells(dragStart, target);
      dragStart = null;
      endTurn();
    }
    function swapCells(a, b) {
      if (a === b) return;
      let t = a.dataset.type;
      a.dataset.type = b.dataset.type;
      b.dataset.type = t;
      a.style.backgroundImage = `url(${images[a.dataset.type]})`;
      b.style.backgroundImage = `url(${images[b.dataset.type]})`;
    }
    function endTurn() {
      clearInterval(timer);
      checkMatches().then(() => {
        if (hp[0] <= 0 || hp[1] <= 0) {
          log.textContent = `–ü–æ–±–µ–¥–∏–ª –ò–≥—Ä–æ–∫ ${hp[0] <= 0 ? 2 : 1}!`;
          return;
        }
        turn = 3 - turn;
        timeLeft = 20;
        startTimer();
      });
    }
    function startTimer() {
      timerBar.style.width = "100%";
      timer = setInterval(() => {
        timeLeft--;
        timerBar.style.width = `${(timeLeft / 20) * 100}%`;
        if (timeLeft <= 0) {
          clearInterval(timer);
          endTurn();
        }
      }, 1000);
    }
    async function checkMatches() {
      const matched = [];
      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width - 2; x++) {
          let a = cell(x, y), b = cell(x + 1, y), c = cell(x + 2, y);
          if (a.dataset.type === b.dataset.type && a.dataset.type === c.dataset.type) {
            matched.push(a, b, c);
            if (x + 3 < width && cell(x + 3, y).dataset.type === a.dataset.type) matched.push(cell(x + 3, y));
            if (x + 4 < width && cell(x + 4, y).dataset.type === a.dataset.type) matched.push(cell(x + 4, y));
          }
        }
      }
      for (let x = 0; x < width; x++) {
        for (let y = 0; y < height - 2; y++) {
          let a = cell(x, y), b = cell(x, y + 1), c = cell(x, y + 2);
          if (a.dataset.type === b.dataset.type && a.dataset.type === c.dataset.type) {
            matched.push(a, b, c);
            if (y + 3 < height && cell(x, y + 3).dataset.type === a.dataset.type) matched.push(cell(x, y + 3));
            if (y + 4 < height && cell(x, y + 4).dataset.type === a.dataset.type) matched.push(cell(x, y + 4));
          }
        }
      }
      const unique = [...new Set(matched)];
      unique.forEach(cell => cell.classList.add("highlight"));
      await new Promise(r => setTimeout(r, 2000));
      for (let cell of unique) cell.classList.remove("highlight");
      await new Promise(r => setTimeout(r, 100));
      unique.forEach(cell => {
        cell.classList.add("fade-out");
        cell.style.transition = "opacity 1s";
      });
      await new Promise(r => setTimeout(r, 1000));
      const count = unique.length;
      unique.forEach(cell => {
        const newType = randomType();
        cell.classList.remove("fade-out");
        cell.dataset.type = newType;
        cell.style.backgroundImage = `url(${images[newType]})`;
        cell.style.opacity = "1";
      });
      applyEffects(count, unique[0]?.dataset.type);
    }
    function applyEffects(count, type) {
      if (!type) return;
      let value = (count >= 5 ? 20 : 10);
      if (type === "attack") {
        hp[2 - turn] -= value;
      } else if (type === "heal") {
        hp[turn - 1] += value;
      }
      hp1.textContent = hp[0];
      hp2.textContent = hp[1];
    }
    function cell(x, y) {
      return grid[y * width + x];
    }
    function randomType() {
      return types[Math.floor(Math.random() * types.length)];
    }
    startGame();
  </script>
</body>
</html>
