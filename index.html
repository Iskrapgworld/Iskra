<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>üî• –ò–°–ö–†–ê: –ë–∏—Ç–≤–∞ TG-–º–∏–Ω–∏ üî•</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { margin: 0; background: #111; color: #fff; font-family: sans-serif; text-align: center; }
    h1 { color: #ffa500; margin: 18px 0 8px 0; font-size: 2.1em; letter-spacing: 2px;}
    #topBar { display: flex; justify-content: space-between; align-items: flex-end; padding: 10px 18px 0 18px; font-size: 15px; }
    .side-block { text-align: left; min-width: 100px; }
    .side-block.monster { text-align: right; }
    .stat-row { display: flex; align-items: center; margin: 4px 0;}
    .stat-icon { font-size: 1.2em; margin-right: 7px;}
    .bar-bg { width: 90px; height: 11px; background: #222; border-radius: 7px; overflow: hidden; margin-left: 4px; margin-right: 0; display: inline-block;}
    .bar { height: 100%; border-radius: 7px; transition: width 0.4s; display: block;}
    .bar-hp { background: linear-gradient(90deg,#54ff63,#ffe35c);}
    .bar-sh { background: linear-gradient(90deg,#79e6ff,#465dc6);}
    .bar-mn { background: linear-gradient(90deg,#cfafff,#5534a9);}
    #battleLog { margin: 10px 0 0 0; padding: 7px; font-size: 18px; min-height: 30px; color: #fff; text-shadow: 0 1px 2px #000b;}
    #timerBarContainer { width: 95%; max-width:370px; margin: 9px auto 0 auto; background:#222; border-radius:7px; height:11px; overflow:hidden;}
    #timerBar { height:100%; width:100%; background:linear-gradient(90deg,#33ff33,#ffff00); transition: width 1s linear;}
    #board { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; width: 340px; max-width:96vw; margin: 18px auto 10px auto; transition: opacity 0.3s;}
    .cell { width: 46px; height: 46px; border-radius: 16%; transition: transform 0.23s, opacity 0.7s;}
    .red    { background: linear-gradient(135deg, #ff5a36 55%, #a00015 100%);}
    .green  { background: linear-gradient(135deg, #57ffab 60%, #00801a 100%);}
    .blue   { background: linear-gradient(135deg, #74e7ff 60%, #184b86 100%);}
    .purple { background: linear-gradient(135deg, #e3a8ff 60%, #441166 100%);}
    .orange { background: linear-gradient(135deg, #ffd97c 60%, #ff9500 100%);}
    .highlight { box-shadow: 0 0 10px 4px #fff8;}
    .fade { opacity: 0.1; }
    .enemy-turn #board { pointer-events: none; opacity: 0.3;}
    .floatText { position: absolute; font-size: 15px; font-weight: bold; pointer-events: none; animation: floatUp 1.1s ease forwards;}
    @keyframes floatUp { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-28px); } }
    /* overlay */
    #overlay, #mainMenu, #characterMenu, #endScreen {
      position: fixed; top:0; left:0; width:100vw; height:100vh;
      background: rgba(0,0,0,0.96);
      display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 999;
    }
    #mainMenu, #characterMenu, #endScreen { display:none;}
    #overlay input {padding: 11px; font-size: 16px; border-radius: 7px; border: none; margin-top: 10px;}
    .overlay-btn {padding: 11px 32px; font-size:18px; border:none; border-radius:11px; background: #892fff; color:white; margin-top:15px;}
    .overlay-btn:active {background:#5d19b8;}
    #lightningButton { margin:10px auto; display:none; background:#ffcc00; color:#000;}
  </style>
</head>
<body>
  <h1>üî• –ò–°–ö–†–ê: –ë–∏—Ç–≤–∞ TG-–º–∏–Ω–∏ üî•</h1>
  <div id="topBar">
    <div class="side-block">
      <div>–í—ã:</div>
      <div class="stat-row"><span class="stat-icon">‚ù§Ô∏è</span><span id="hpVal">200</span>
        <span class="bar-bg"><span id="hpBar" class="bar bar-hp" style="width:100%"></span></span>
      </div>
      <div class="stat-row"><span class="stat-icon">üõ°</span><span id="shieldVal">100</span>
        <span class="bar-bg"><span id="shieldBar" class="bar bar-sh" style="width:100%"></span></span>
      </div>
      <div class="stat-row"><span class="stat-icon">üîÆ</span><span id="manaVal">0</span>
        <span class="bar-bg"><span id="manaBar" class="bar bar-mn" style="width:0%"></span></span>
      </div>
    </div>
    <div class="side-block monster">
      <div>–ú–æ–Ω—Å—Ç—Ä:</div>
      <div class="stat-row"><span class="stat-icon">üíÄ</span><span id="enemyHpVal">100</span>
        <span class="bar-bg"><span id="enemyHpBar" class="bar bar-hp" style="width:100%"></span></span>
      </div>
      <div class="stat-row"><span class="stat-icon">üõ°</span><span id="enemyShieldVal">100</span>
        <span class="bar-bg"><span id="enemyShieldBar" class="bar bar-sh" style="width:100%"></span></span>
      </div>
      <div class="stat-row"><span class="stat-icon">üîÆ</span><span id="enemyManaVal">0</span>
        <span class="bar-bg"><span id="enemyManaBar" class="bar bar-mn" style="width:0%"></span></span>
      </div>
    </div>
  </div>
  <div id="timerBarContainer"><div id="timerBar"></div></div>
  <div id="battleLog">–ö–æ–º–±–æ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å‚Ä¶</div>
  <div id="board"></div>
  <button id="lightningButton" onclick="useLightning()">‚ö° –ú–æ–ª–Ω–∏—è (20 –º–∞–Ω—ã)</button>
  <!-- Overlay –¥–ª—è –ª–æ–≥–∏–Ω–∞ -->
  <div id="overlay">
    <h2 style="margin-bottom:14px; font-size:2em; color:#fff;">–í–≤–µ–¥–∏—Ç–µ –∏–º—è:</h2>
    <input id="nickname" placeholder="–ò–º—è –∏–≥—Ä–æ–∫–∞">
    <button class="overlay-btn" id="goNext">–î–∞–ª–µ–µ</button>
  </div>
  <!-- –ú–µ–Ω—é -->
  <div id="mainMenu">
    <h2 style="font-size:2em; color:#fff;">–ú–µ–Ω—é</h2>
    <button class="overlay-btn" id="toBattle">–í –±–æ–π!</button>
    <button class="overlay-btn" id="toChar">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
  </div>
  <!-- –ü—Ä–æ–∫–∞—á–∫–∞ -->
  <div id="characterMenu">
    <h2 style="font-size:2em; color:#fff;">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h2>
    <div>–û–ø—ã—Ç: <span id="xp">0</span> | –û—á–∫–∏: <span id="skillPoints">0</span></div>
    <div>–°–∏–ª–∞: <span id="str">1</span> <button onclick="upgrade('str')">+</button></div>
    <div>–õ–æ–≤–∫–æ—Å—Ç—å: <span id="agi">1</span> <button onclick="upgrade('agi')">+</button></div>
    <div>–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç: <span id="int">1</span> <button onclick="upgrade('int')">+</button></div>
    <div>–ñ–∏–≤—É—á–µ—Å—Ç—å: <span id="vit">1</span> <button onclick="upgrade('vit')">+</button></div>
    <div>–£–¥–∞—á–∞: <span id="luck">1</span> <button onclick="upgrade('luck')">+</button></div>
    <button class="overlay-btn" onclick="backToMenu()">–ù–∞–∑–∞–¥</button>
  </div>
  <!-- –ö–æ–Ω–µ—Ü –±–æ—è -->
  <div id="endScreen">
    <h2 id="endMessage" style="font-size:2em; color:#fff;">–ü–æ–±–µ–¥–∞!</h2>
    <button class="overlay-btn" onclick="showMainMenu()">–í –º–µ–Ω—é</button>
  </div>
<script>
  // ======= –ú–µ–Ω—é –∏ –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ ======
  const overlay = document.getElementById("overlay");
  const mainMenu = document.getElementById("mainMenu");
  const charMenu = document.getElementById("characterMenu");
  const endScreen = document.getElementById("endScreen");
  document.getElementById("goNext").addEventListener("click", () => {
    overlay.style.display = "none";
    mainMenu.style.display = "flex";
  });
  document.getElementById("toBattle").addEventListener("click", () => {
    mainMenu.style.display = "none";
    startGame();
  });
  document.getElementById("toChar").addEventListener("click", () => {
    mainMenu.style.display = "none";
    charMenu.style.display = "flex";
    updateCharacterUI();
  });
  function showMainMenu() {
    mainMenu.style.display = "flex";
    charMenu.style.display = "none";
    endScreen.style.display = "none";
  }
  function backToMenu() {
    charMenu.style.display = "none";
    mainMenu.style.display = "flex";
  }
  // –ü—Ä–æ–∫–∞—á–∫–∞
  let attributes = { str: 1, agi: 1, int: 1, vit: 1, luck: 1 };
  let xp = 0, skillPoints = 0;
  const xpEl = document.getElementById("xp");
  const skillPointsEl = document.getElementById("skillPoints");
  const attrEls = {
    str: document.getElementById("str"),
    agi: document.getElementById("agi"),
    int: document.getElementById("int"),
    vit: document.getElementById("vit"),
    luck: document.getElementById("luck")
  };
  function updateCharacterUI() {
    xpEl.textContent = xp;
    skillPointsEl.textContent = skillPoints;
    for (let key in attributes) attrEls[key].textContent = attributes[key];
  }
  function upgrade(attr) {
    if (skillPoints > 0) {
      attributes[attr]++;
      skillPoints--;
      updateCharacterUI();
    }
  }
  // ======= –ë–û–ï–í–ê–Ø –õ–û–ì–ò–ö–ê =======
  const hpEl = document.getElementById("hpVal");
  const shieldEl = document.getElementById("shieldVal");
  const manaEl = document.getElementById("manaVal");
  const enemyHpEl = document.getElementById("enemyHpVal");
  const enemyShieldEl = document.getElementById("enemyShieldVal");
  const enemyManaEl = document.getElementById("enemyManaVal");
  const hpBar = document.getElementById("hpBar");
  const shieldBar = document.getElementById("shieldBar");
  const manaBar = document.getElementById("manaBar");
  const enemyHpBar = document.getElementById("enemyHpBar");
  const enemyShieldBar = document.getElementById("enemyShieldBar");
  const enemyManaBar = document.getElementById("enemyManaBar");
  const board = document.getElementById("board");
  const battleLog = document.getElementById("battleLog");
  const timerBar = document.getElementById("timerBar");
  const lightningBtn = document.getElementById("lightningButton");
  const endMessage = document.getElementById("endMessage");
  // –ù–∞—á–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
  let hp = 200, shield = 100, mana = 0;
  let enemyHp = 100, enemyShield = 100, enemyMana = 0;
  let grid = [], dragging = null, isPlayerTurn = true, turnTimer;
  let comboAccumulator = [], bonusPercent = 0;
  let lightningUsed = false;
  const colors = ['red', 'green', 'blue', 'purple', 'orange'];
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–æ–≤
  function updateStats() {
    hpEl.textContent = hp;
    shieldEl.textContent = shield;
    manaEl.textContent = mana;
    enemyHpEl.textContent = enemyHp;
    enemyShieldEl.textContent = enemyShield;
    enemyManaEl.textContent = enemyMana;
    hpBar.style.width = (hp/200*100)+"%";
    shieldBar.style.width = (shield/100*100)+"%";
    manaBar.style.width = (mana/100*100)+"%";
    enemyHpBar.style.width = (enemyHp/100*100)+"%";
    enemyShieldBar.style.width = (enemyShield/100*100)+"%";
    enemyManaBar.style.width = (enemyMana/100*100)+"%";
  }
  // –ù–∞—á–∞–ª–æ –±–æ—è
  function startGame() {
    hp = 200; shield = 100; mana = 0;
    enemyHp = 100; enemyShield = 100; enemyMana = 0;
    lightningUsed = false;
    updateStats();
    createGrid();
    endScreen.style.display = "none";
    document.body.classList.remove("enemy-turn");
    isPlayerTurn = true;
    lightningBtn.style.display = "none";
    startTurn();
  }
  // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—è 6x6 –±–µ–∑ —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –∫–æ–º–±–æ
  function createGrid() {
    board.innerHTML = "";
    grid = [];
    do {
      board.innerHTML = "";
      grid = [];
      for (let i = 0; i < 36; i++) {
        const cell = document.createElement("div");
        cell.className = "cell " + colors[Math.floor(Math.random() * colors.length)];
        board.appendChild(cell);
        grid.push(cell);
      }
    } while (checkMatches().length > 0);
  }
  function index(r, c) { return r * 6 + c; }
  function getColor(el) { return colors.find(c => el.classList.contains(c)); }
  // ==== –•–û–î –ò–ì–†–û–ö–ê ====
  function startTurn() {
    isPlayerTurn = true; lightningUsed = false;
    comboAccumulator = [];
    document.body.classList.remove("enemy-turn");
    board.style.pointerEvents = "auto";
    lightningBtn.style.display = mana >= 20 ? "inline-block" : "none";
    let time = 20;
    timerBar.style.width = "100%";
    clearInterval(turnTimer);
    turnTimer = setInterval(() => {
      time--;
      timerBar.style.width = (time * 5) + "%";
      if (time <= 0) {
        clearInterval(turnTimer);
        board.style.pointerEvents = "none";
        resolveCascade();
      }
    }, 1000);
  }
  // ==== –°–õ–û–í–õ–ò–í–ê–ï–ú –í–°–ï –ö–û–ú–ë–û (–ö–ê–°–ö–ê–î–´) ====
  function resolveCascade(bonusFromCascade=0, wasMove=false) {
    let matches = checkMatches();
    if (!wasMove && matches.length===0) return; // –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
    if (matches.length === 0) {
      // –°—á–∏—Ç–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã (–≤—Å–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –∑–∞ –≤—Å–µ –∫–æ–º–±–æ)
      let summary = {red:0,green:0,blue:0,orange:0,purple:0,count:0, chain:0};
      for (let arr of comboAccumulator) {
        for (let k in summary) if (arr[k]) summary[k] += arr[k];
        summary.count += arr.count||0;
        summary.chain++;
      }
      // –°—É–º–º–∏—Ä—É–µ–º –±–æ–Ω—É—Å –∑–∞ –≤—Å–µ —Ü–µ–ø–∏ (–ø–æ 5% –∑–∞ –∫–∞–∂–¥—É—é –¥–æ–ø.–∫–æ–º–±—É)
      let comboBonus = Math.max(0, summary.chain-1)*0.05;
      let dmg = summary.red >= 5 ? 20 : summary.red >= 3 ? 10 : 0;
      dmg += Math.round(dmg * comboBonus);
      let heal = summary.green >= 5 ? 10 : summary.green >= 3 ? 5 : 0;
      heal += Math.round(heal * comboBonus);
      let def = summary.blue >= 5 ? 10 : summary.blue >= 3 ? 5 : 0;
      def += Math.round(def * comboBonus);
      let manaGain = summary.purple >= 5 ? 20 : summary.purple >= 3 ? 10 : 0;
      manaGain += Math.round(manaGain * comboBonus);
      if (isPlayerTurn) {
        mana += manaGain;
        if (mana > 100) mana = 100;
      } else {
        enemyMana +=
