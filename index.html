<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>üî• –ò–°–ö–†–ê: –ë–∏—Ç–≤–∞ TG-–º–∏–Ω–∏ üî•</title>
  <style>
    body { margin: 0; background: #111; color: #fff; font-family: sans-serif; text-align: center; }
    h1 { color: #ffa500; margin: 14px 0 4px 0; font-size: 2.2em; }
    #topBar { display: flex; justify-content: space-between; align-items: center; margin: 0 10px 10px 10px; font-size: 18px; }
    .stats { flex: 1; min-width: 140px; }
    .bar { height: 14px; border-radius: 8px; margin: 3px 0 10px 0; background: #222; box-shadow: 0 0 4px #000; overflow: hidden; width: 96%; margin-left: 2%; margin-right: 2%; }
    .hpbar { background: linear-gradient(90deg,#33ff33,#ffff00);}
    .shieldbar { background: linear-gradient(90deg,#66ccff,#003366);}
    .manabar { background: linear-gradient(90deg,#bb7cff,#33224c);}
    #timerBarContainer { width: 100%; margin: 2px 0 6px 0; background: #222; border-radius: 8px; height: 8px; overflow: hidden; }
    #timerBar { height: 100%; background: linear-gradient(90deg,#3fa,#fd0); width:100%; transition: width 0.2s linear; }
    #battleLog { font-size: 1.3em; margin: 15px 0 12px 0; min-height: 20px;}
    #board { display: grid; grid-template-columns: repeat(6,42px); gap:6px; justify-content:center; margin:20px auto 0 auto; width: 270px; transition: opacity 0.2s; }
    .cell { width: 40px; height: 40px; border-radius: 9px; box-shadow: 0 2px 7px #0008; transition: transform 0.15s, opacity 0.3s; background: #222; }
    .red    { background: linear-gradient(135deg,#ff4d4d 65%,#800 100%);}
    .green  { background: linear-gradient(135deg,#66ff66 70%,#094c09 100%);}
    .blue   { background: linear-gradient(135deg,#66ccff 75%,#003366 100%);}
    .purple { background: linear-gradient(135deg,#dca0ff 80%,#440066 100%);}
    .orange { background: linear-gradient(135deg,#ffcd68 75%,#b78a3e 100%);}
    .highlight { box-shadow: 0 0 16px 6px #fff6; }
    .fade { opacity: 0; }
    .enemy-turn #board { opacity: 0.25; pointer-events: none;}
    #overlay { position:fixed; top:0; left:0; width:100vw; height:100vh; background:#18111aeb; z-index:100; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    #overlay input { margin:5px 0; padding:10px; font-size:18px; border-radius:6px; border:none; width:210px; text-align:center; }
    #overlay button { padding:10px 24px; font-size:20px; border-radius:10px; border:none; margin-top:12px; background:#a55eff; color:#fff; font-weight:bold; cursor:pointer; }
    .floatText { position:absolute; font-size:17px; font-weight:bold; pointer-events:none; animation:floatUp 1s linear forwards; left: 50%; transform: translateX(-50%);}
    @keyframes floatUp { from {opacity:1;} to {opacity:0;transform:translateY(-32px) translateX(-50%);} }
    #lightningButton { margin:10px auto; display:none; background:#ffd700; color:#000; font-weight:bold; font-size:17px; border-radius:8px; border:none; padding:8px 26px; cursor:pointer; }
    #endScreen { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(20,20,20,0.95); z-index:101; display:none; flex-direction:column; justify-content:center; align-items:center; font-size:2em; }
    #endScreen button { margin-top:24px; padding:10px 30px; font-size:1em; border-radius:8px; background:#ffa500; color:#fff; border:none;}
    @media (max-width:500px) { #board {width:96vw; grid-template-columns: repeat(6, 14vw);} .cell {width:14vw; height:14vw;} }
  </style>
</head>
<body>
  <h1>üî• –ò–°–ö–†–ê: –ë–∏—Ç–≤–∞ TG-–º–∏–Ω–∏ üî•</h1>
  <div id="topBar">
    <div class="stats" style="text-align:left;">
      –í—ã:<br>
      <span style="font-size:1.3em;">‚ù§Ô∏è</span> <span id="hp">200</span>
      <div class="bar"><div class="hpbar" id="hpbar" style="width:100%"></div></div>
      <span style="font-size:1.2em;">üõ°</span> <span id="shield">100</span>
      <div class="bar"><div class="shieldbar" id="shieldbar" style="width:100%"></div></div>
      <span style="font-size:1.2em;">üîÆ</span> <span id="mana">0</span>
      <div class="bar"><div class="manabar" id="manabar" style="width:0%"></div></div>
    </div>
    <div class="stats" style="text-align:right;">
      –ú–æ–Ω—Å—Ç—Ä:<br>
      <span style="font-size:1.3em;">üíÄ</span> <span id="enemyHp">100</span>
      <div class="bar"><div class="hpbar" id="enemyHpbar" style="width:100%"></div></div>
      <span style="font-size:1.2em;">üõ°</span> <span id="enemyShield">100</span>
      <div class="bar"><div class="shieldbar" id="enemyShieldbar" style="width:100%"></div></div>
      <span style="font-size:1.2em;">üîÆ</span> <span id="enemyMana">0</span>
      <div class="bar"><div class="manabar" id="enemyManabar" style="width:0%"></div></div>
    </div>
  </div>
  <div id="timerBarContainer"><div id="timerBar"></div></div>
  <div id="battleLog">–ö–æ–º–±–æ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å‚Ä¶</div>
  <div id="board"></div>
  <button id="lightningButton">‚ö° –ú–æ–ª–Ω–∏—è (20 –º–∞–Ω—ã)</button>
  <div id="overlay">
    <h2 style="color:#fff;margin-bottom:10px;">–í—Ö–æ–¥ –≤ –∏–≥—Ä—É</h2>
    <input id="nickname" placeholder="–õ–æ–≥–∏–Ω">
    <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button id="loginBtn">–í–æ–π—Ç–∏</button>
  </div>
  <div id="endScreen">
    <div id="endMessage"></div>
    <button onclick="location.reload()">–í –º–µ–Ω—é</button>
  </div>
<script>
  // --- –õ–æ–≥–∏–Ω-–∑–∞–≥–ª—É—à–∫–∞ ---
  document.getElementById('loginBtn').addEventListener('click', function() {
    if (!document.getElementById('nickname').value.trim() || !document.getElementById('password').value.trim()) {
      alert("–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å!"); return;
    }
    document.getElementById('overlay').style.display = "none";
    setTimeout(initGame,100); // –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
  });

  // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
  let hp=200, shield=100, mana=0, enemyHp=100, enemyShield=100, enemyMana=0;
  let grid = [], dragging = null, isPlayerTurn=true, turnTimer, timeLeft, lightningUsed = false;
  let board = document.getElementById("board");
  let hpEl = document.getElementById("hp"), shieldEl = document.getElementById("shield"), manaEl = document.getElementById("mana");
  let enemyHpEl = document.getElementById("enemyHp"), enemyShieldEl = document.getElementById("enemyShield"), enemyManaEl = document.getElementById("enemyMana");
  let hpbar=document.getElementById("hpbar"), shieldbar=document.getElementById("shieldbar"), manabar=document.getElementById("manabar");
  let enemyHpbar=document.getElementById("enemyHpbar"), enemyShieldbar=document.getElementById("enemyShieldbar"), enemyManabar=document.getElementById("enemyManabar");
  let lightningBtn=document.getElementById("lightningButton");
  let timerBar=document.getElementById("timerBar"), battleLog=document.getElementById("battleLog");
  let endScreen=document.getElementById("endScreen"), endMessage=document.getElementById("endMessage");
  const colors = ['red','green','blue','purple','orange'];

  function initGame() {
    createGrid(); updateStats(); startTurn();
  }

  function updateStats() {
    hpEl.textContent = hp; shieldEl.textContent = shield; manaEl.textContent = mana;
    enemyHpEl.textContent = enemyHp; enemyShieldEl.textContent = enemyShield; enemyManaEl.textContent = enemyMana;
    hpbar.style.width = (hp/200*100)+"%";
    shieldbar.style.width = (shield/100*100)+"%";
    manabar.style.width = (mana/100*100)+"%";
    enemyHpbar.style.width = (enemyHp/100*100)+"%";
    enemyShieldbar.style.width = (enemyShield/100*100)+"%";
    enemyManabar.style.width = (enemyMana/100*100)+"%";
  }

  function createGrid() {
    board.innerHTML = ""; grid = [];
    do {
      for (let i=0; i<36; i++) {
        let cell = document.createElement("div");
        cell.className = "cell "+colors[Math.floor(Math.random()*colors.length)];
        board.appendChild(cell); grid.push(cell);
      }
    } while (hasInitialMatches());
  }
  function hasInitialMatches() {
    for (let r=0;r<6;r++) for (let c=0;c<4;c++)
      if (getColor(grid[r*6+c])===getColor(grid[r*6+c+1]) && getColor(grid[r*6+c+1])===getColor(grid[r*6+c+2])) return true;
    for (let c=0;c<6;c++) for (let r=0;r<4;r++)
      if (getColor(grid[r*6+c])===getColor(grid[(r+1)*6+c]) && getColor(grid[(r+1)*6+c])===getColor(grid[(r+2)*6+c])) return true;
    return false;
  }
  function getColor(el) { return colors.find(c=>el.classList.contains(c)); }

  function startTurn() {
    isPlayerTurn = true; lightningUsed = false;
    document.body.classList.remove("enemy-turn");
    lightningBtn.style.display = (mana>=20) ? "inline-block" : "none";
    timeLeft = 20; timerBar.style.width = "100%";
    clearInterval(turnTimer);
    turnTimer = setInterval(() => {
      timeLeft--; timerBar.style.width = (timeLeft/20*100)+"%";
      if (timeLeft<=0) { clearInterval(turnTimer); board.style.pointerEvents="none"; resolveAllCombos(); }
    }, 1000);
    board.style.pointerEvents="auto";
  }
  lightningBtn.onclick = function() {
    if (isPlayerTurn && mana>=20 && !lightningUsed) { lightningUsed = true; mana-=20; updateStats(); lightningBtn.style.display = "none"; }
  };

  // Drag & Drop
  board.addEventListener("touchstart", e => {
    let t = e.touches[0], el = document.elementFromPoint(t.clientX,t.clientY);
    if (el && el.classList.contains("cell")) dragging = el;
  });
  board.addEventListener("touchmove", e => {
    if (!dragging) return;
    let t = e.touches[0], el = document.elementFromPoint(t.clientX,t.clientY);
    if (el && el.classList.contains("cell") && el!==dragging) {
      [dragging.className,el.className] = [el.className,dragging.className];
      dragging = el;
    }
  });
  board.addEventListener("touchend", () => {
    dragging=null; clearInterval(turnTimer); board.style.pointerEvents="none"; resolveAllCombos();
  });
  board.addEventListener("mousedown", e=>{
    if (e.target.classList.contains("cell")) dragging = e.target;
  });
  board.addEventListener("mousemove", e=>{
    if (!dragging) return;
    let el = document.elementFromPoint(e.clientX,e.clientY);
    if (el && el.classList.contains("cell") && el!==dragging) {
      [dragging.className,el.className] = [el.className,dragging.className];
      dragging = el;
    }
  });
  board.addEventListener("mouseup", ()=>{
    dragging=null; clearInterval(turnTimer); board.style.pointerEvents="none"; resolveAllCombos();
  });

  // --- –ö–ê–°–ö–ê–î–´ + –ö–û–ú–ë–û ---
  function resolveAllCombos() {
    let total = {red:0,green:0,blue:0,orange:0,purple:0,combo:0};
    let hasMatches = false, affected = [];
    function collectCombo() {
      let matches = findMatches();
      if (!matches.length) return false;
      hasMatches = true; total.combo+=matches.length;
      for (let group of matches) {
        let color = getColor(grid[group[0]]);
        total[color] += group.length;
        for (let idx of group) { grid[idx].classList.add("highlight"); affected.push(idx);}
      }
      return true;
    }
    function cleanCombo() {
      affected.forEach(idx=>{grid[idx].classList.remove("highlight"); grid[idx].classList.add("fade");});
      setTimeout(()=>{
        affected.forEach(idx=>grid[idx].className="cell");
        dropDown();
        setTimeout(()=>{affected=[]; if (collectCombo()) {cleanCombo();} else {applyEffects(total);}},700);
      },1300);
    }
    if (collectCombo()) { cleanCombo(); }
    else { applyEffects(total); }
  }

  function findMatches() {
    let found=[];
    for (let r=0;r<6;r++) for (let c=0;c<4;c++) {
      let i=r*6+c, a=grid[i],b=grid[i+1],c_=grid[i+2];
      if (getColor(a)===getColor(b)&&getColor(b)===getColor(c_))
        found.push([i,i+1,i+2]);
    }
    for (let c=0;c<6;c++) for (let r=0;r<4;r++) {
      let i=r*6+c,a=grid[i],b=grid[i+6],c_=grid[i+12];
      if (getColor(a)===getColor(b)&&getColor(b)===getColor(c_))
        found.push([i,i+6,i+12]);
    }
    return found;
  }
  function dropDown() {
    for (let c=0;c<6;c++) {
      for (let r=5;r>0;r--) {
        let i=r*6+c;
        if (!getColor(grid[i])) {
          for (let k=r-1;k>=0;k--) {
            let up=k*6+c;
            if (getColor(grid[up])) {
              grid[i].className=grid[up].className;
              grid[up].className="cell"; break;
            }
          }
        }
      }
      for (let r=0;r<6;r++) {
        let i=r*6+c;
        if (!getColor(grid[i])) grid[i].className="cell "+colors[Math.floor(Math.random()*colors.length)];
      }
    }
  }

  function applyEffects(total) {
    let bonus = total.combo*0.05, dmg=0, heal=0, def=0, manaAdd=0;
    if (total.red>=5) dmg=20; else if (total.red>=3) dmg=10;
    if (total.green>=5) heal=10; else if (total.green>=3) heal=5;
    if (total.blue>=5) def=10; else if (total.blue>=3) def=5;
    if (total.purple>=5) manaAdd=20; else if (total.purple>=3) manaAdd=10;
    dmg = Math.round(dmg*(1+bonus));
    heal = Math.round(heal*(1+bonus));
    def = Math.round(def*(1+bonus));
    manaAdd = Math.round(manaAdd*(1+bonus));
    if (isPlayerTurn && lightningUsed) dmg+=50;
    if (isPlayerTurn) {
      mana
