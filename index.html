<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ò–°–ö–†–ê: –®–∞—Ö—Ç–∞</title>
  <style>
    body {
      margin: 0;
      background-color: #111;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
    }
    h1 {
      color: #ffcc00;
      margin-top: 10px;
    }
    #topBar {
      display: flex;
      justify-content: space-around;
      margin: 10px;
      font-size: 14px;
    }
    .stat {
      line-height: 1.6;
    }
    .bar {
      height: 12px;
      background: #333;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 3px;
    }
    .bar-inner {
      height: 100%;
      transition: width 0.5s ease;
    }
    #spark { color: #ffff66; }
    #board {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 4px;
      width: 360px;
      margin: 10px auto;
    }
    .cell {
      width: 58px;
      height: 58px;
      border-radius: 50%;
      transition: transform 0.3s ease;
    }
    .red    { background: radial-gradient(circle, #ff4d4d, #990000); }
    .green  { background: radial-gradient(circle, #66ff66, #006600); }
    .blue   { background: radial-gradient(circle, #66ccff, #003366); }
    .orange { background: radial-gradient(circle, #ffaa00, #993300); }
    .purple { background: radial-gradient(circle, #cc99ff, #330066); }
    .highlight { box-shadow: 0 0 8px 4px #fff5; }
    .fade { opacity: 0; }
    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      background: #444;
      color: #fff;
      border: none;
      border-radius: 10px;
    }
    #result {
      font-size: 14px;
      margin-top: 10px;
      min-height: 20px;
    }
    #depth {
      font-size: 16px;
      margin-bottom: 5px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <h1>‚õè –®–∞—Ö—Ç–∞ –ò—Å–∫—Ä—ã</h1>
  <div id="depth">–ì–ª—É–±–∏–Ω–∞: 0 –º</div>
  <div id="topBar">
    <div class="stat">
      ‚ö° –ò—Å–∫—Ä–∞: <span id="spark">30</span>
    </div>
    <div class="stat">
      üí® –í–æ–∑–¥—É—Ö
      <div class="bar"><div id="airBar" class="bar-inner" style="width:100%;background:#00ffcc;"></div></div>
    </div>
    <div class="stat">
      üß± –°–≤–æ–¥
      <div class="bar"><div id="roofBar" class="bar-inner" style="width:100%;background:#3399ff;"></div></div>
    </div>
  </div>
  <div id="board"></div>
  <button onclick="startMiningTurn()">üîÅ –°–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥ (-5 –ò—Å–∫—Ä—ã)</button>
  <div id="result"></div>

  <script>
    const colors = ['red', 'green', 'blue', 'orange', 'purple'];
    const board = document.getElementById("board");
    const sparkEl = document.getElementById("spark");
    const airBar = document.getElementById("airBar");
    const roofBar = document.getElementById("roofBar");
    const result = document.getElementById("result");
    const depthText = document.getElementById("depth");

    let spark = 3000;
    let dragging = null;
    let grid = [];
    let depth = 0;

    function createBoard() {
      board.innerHTML = "";
      grid = [];
      for (let i = 0; i < 36; i++) {
        const cell = document.createElement("div");
        const color = colors[Math.floor(Math.random() * colors.length)];
        cell.className = "cell " + color;
        board.appendChild(cell);
        grid.push(cell);
      }
    }

    function index(r, c) {
      return r * 6 + c;
    }

    function getColor(el) {
      return colors.find(c => el.classList.contains(c));
    }

    function startMiningTurn() {
      if (spark < 5) {
        alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ò—Å–∫—Ä—ã!");
        return;
      }
      spark -= 5;
      sparkEl.textContent = spark;
      resolveCascade();
    }

    function checkMatches() {
      const matches = [];
      for (let r = 0; r < 6; r++) {
        for (let c = 0; c < 4; c++) {
          let i = index(r, c);
          let a = grid[i], b = grid[i+1], c_ = grid[i+2];
          if (getColor(a) === getColor(b) && getColor(b) === getColor(c_))
            matches.push([i, i+1, i+2]);
        }
      }
      for (let c = 0; c < 6; c++) {
        for (let r = 0; r < 4; r++) {
          let i = index(r, c);
          let a = grid[i], b = grid[i+6], c_ = grid[i+12];
          if (getColor(a) === getColor(b) && getColor(b) === getColor(c_))
            matches.push([i, i+6, i+12]);
        }
      }
      return matches;
    }

    function resolveCascade() {
      const matches = checkMatches();
      const tally = { red: 0, green: 0, blue: 0, orange: 0, purple: 0 };
      if (matches.length === 0) {
        result.textContent = "–ö–æ–º–±–∏–Ω–∞—Ü–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ";
        return;
      }

      matches.forEach(g => {
        const color = getColor(grid[g[0]]);
        tally[color] += g.length;
        g.forEach(i => grid[i].classList.add("highlight"));
      });

      setTimeout(() => {
        matches.flat().forEach(i => {
          grid[i].classList.remove("highlight");
          grid[i].classList.add("fade");
        });
        setTimeout(() => {
          matches.flat().forEach(i => {
            const newColor = colors[Math.floor(Math.random() * colors.length)];
            grid[i].className = "cell " + newColor;
            grid[i].classList.remove("fade");
          });
          applyMiningEffects(tally);
        }, 500);
      }, 800);
    }

    function applyMiningEffects(tally) {
      let air = parseInt(airBar.style.width) || 100;
      let roof = parseInt(roofBar.style.width) || 100;
      let loot = "";

      if (tally.green >= 3) air += 5;
      if (tally.green >= 5) air += 5;
      if (tally.blue >= 3) roof += 5;
      if (tally.blue >= 5) roof += 5;
      air -= 3;
      roof -= 2;

      // –≥–ª—É–±–∏–Ω–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –∑–∞ –∫–∞–∂–¥—ã–π —Ö–æ–¥ —Å –∫—Ä–∞—Å–Ω—ã–º–∏
      if (tally.red >= 3) {
        depth += 5;
        if (tally.red >= 5) depth += 5;
      }

      // –õ—É—Ç
      if (tally.red >= 7) loot = "üåü –†—É–¥–∞ –ò—Å–∫—Ä—ã";
      else if (tally.red >= 5) loot = "ü™® –ñ–µ–ª–µ–∑–Ω–∞—è —Ä—É–¥–∞";
      else if (tally.red >= 3) loot = "üóø –ö–∞–º–µ–Ω—å";

      air = Math.max(0, Math.min(100, air));
      roof = Math.max(0, Math.min(100, roof));
      airBar.style.width = air + "%";
      roofBar.style.width = roof + "%";
      depthText.textContent = `–ì–ª—É–±–∏–Ω–∞: ${depth} –º`;

      if (roof <= 10) {
        result.textContent = "‚ùå –û–±–≤–∞–ª! –®–∞—Ö—Ç–∞ —Ä–∞–∑—Ä—É—à–µ–Ω–∞!";
        spark = 0;
        sparkEl.textContent = spark;
        return;
      }

      result.textContent = loot ? `–î–æ–±—ã—Ç–æ: ${loot}` : "–ù–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤";
    }

    board.addEventListener("touchstart", e => {
      const t = e.touches[0];
      const el = document.elementFromPoint(t.clientX, t.clientY);
      if (el && el.classList.contains("cell")) dragging = el;
    });
    board.addEventListener("touchmove", e => {
      if (!dragging) return;
      const t = e.touches[0];
      const el = document.elementFromPoint(t.clientX, t.clientY);
      if (el && el.classList.contains("cell") && el !== dragging) {
        [dragging.className, el.className] = [el.className, dragging.className];
        dragging = el;
      }
    });
    board.addEventListener("touchend", () => {
      dragging = null;
    });

    createBoard();
  </script>
</body>
</html>
