<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ò–°–ö–†–ê: –ë–∏—Ç–≤–∞ v1.4</title>
  <meta name="viewport" content="width=480, initial-scale=1.0, user-scalable=no">
  <style>
    body {
      margin: 0;
      background: #181825;
      color: #fff;
      font-family: sans-serif;
      min-height: 100vh;
      text-align: center;
    }
    #mainMenu, #charMenu, #endScreen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #181825;
      position: absolute;
      width: 100vw;
      top: 0; left: 0;
      z-index: 10;
    }
    #mainMenu, #endScreen {gap: 20px;}
    #charMenu {gap: 14px;}
    h1 { color: #ffa500; margin-bottom: 10px; }
    button {
      background: #ffa500;
      border: none;
      border-radius: 8px;
      padding: 10px 25px;
      font-size: 20px;
      color: #222;
      cursor: pointer;
      margin: 4px 0;
      font-weight: bold;
      transition: background 0.2s;
    }
    button:active {background: #ffbe40;}
    #board {
      width: 330px;
      height: 330px;
      display: grid;
      grid-template: repeat(6, 1fr)/repeat(6, 1fr);
      gap: 2px;
      margin: 18px auto 10px;
      background: #24243d;
      border-radius: 16px;
      box-shadow: 0 0 16px #181825;
      touch-action: none;
    }
    .cell {
      width: 52px; height: 52px;
      border-radius: 12px;
      box-shadow: 0 1px 6px #0004;
      background: #222;
      transition: box-shadow 0.3s, filter 0.4s;
      user-select: none;
      display: flex; align-items: center; justify-content: center;
      font-weight: bold;
      font-size: 18px;
      border: 2px solid #2e2e3c;
      position: relative;
    }
    .red    {background: linear-gradient(145deg, #b93d37, #ff4747);}
    .green  {background: linear-gradient(145deg, #43b954, #79ff79);}
    .blue   {background: linear-gradient(145deg, #4470b9, #4fd2ff);}
    .purple {background: linear-gradient(145deg, #8b4bb9, #b078ff);}
    .orange {background: linear-gradient(145deg, #b97b37, #ffc947);}
    .highlight {box-shadow: 0 0 24px 8px #fff8, 0 0 12px 2px #ffa50099 inset !important;}
    .fade {filter: brightness(2) blur(2px) opacity(0.1); transition: filter 1s;}
    #battleLog {
      min-height: 34px;
      font-size: 18px;
      margin-bottom: 6px;
    }
    .floatText {
      position: fixed;
      z-index: 1000;
      font-size: 20px;
      pointer-events: none;
      animation: floatUp 1.5s linear;
      font-weight: bold;
      text-shadow: 0 2px 10px #000;
    }
    @keyframes floatUp {
      0% {opacity: 1; transform: translateY(0);}
      100% {opacity: 0; transform: translateY(-50px);}
    }
    #stats, #enemyStats {
      display: flex;
      gap: 16px;
      justify-content: center;
      font-size: 18px;
      margin: 8px auto 0;
    }
    #enemyStats {margin-bottom: 0;}
    #timerBarContainer {
      height: 14px;
      background: #333;
      border-radius: 7px;
      width: 310px;
      margin: 6px auto 8px;
      overflow: hidden;
      box-shadow: 0 1px 6px #0004;
    }
    #timerBar {
      background: linear-gradient(90deg, #ffa500 0%, #ffd26a 100%);
      width: 100%;
      height: 100%;
      border-radius: 7px;
      transition: width 1s linear;
    }
    .enemy-turn #board {filter: brightness(0.75) grayscale(0.3);}
    .enemy-turn #battleLog {color: #ff4444 !important;}
    #lightningBtn {
      display: none;
      margin: 0 auto 12px;
      background: linear-gradient(90deg,#ffe259 0,#ffa751 100%);
      color: #b92d2d; border-radius: 12px;
      font-weight: bold; font-size: 18px; padding: 7px 24px;
      box-shadow: 0 1px 4px #0004;
    }
    #charMenu table {
      margin: 10px auto;
      font-size: 18px;
      border-collapse: collapse;
      color: #fff;
      width: 90%;
    }
    #charMenu th, #charMenu td {
      border-bottom: 1px solid #444;
      padding: 6px 0;
    }
    #charMenu button.upgrade {
      padding: 2px 8px;
      font-size: 14px;
      margin-left: 6px;
      background: #ffa500bb;
    }
  </style>
</head>
<body>
<div id="mainMenu">
  <h1>–ò–°–ö–†–ê: –ë–∏—Ç–≤–∞</h1>
  <button onclick="startGame()">–í –±–æ–π!</button>
  <button onclick="showCharacterMenu()">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
</div>
<div id="charMenu">
  <h2>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h2>
  <div>–û–ø—ã—Ç (–∏—Å–∫—Ä—ã): <span id="xpEl">0</span></div>
  <div>–ù–∞–≤—ã–∫–æ–≤: <span id="skillPointsEl">0</span></div>
  <table>
    <tr><th>–°–∏–ª–∞</th><td><span id="attrStr">0</span><button class="upgrade" onclick="upgrade('str')">+</button></td></tr>
    <tr><th>–õ–æ–≤–∫–æ—Å—Ç—å</th><td><span id="attrDex">0</span><button class="upgrade" onclick="upgrade('dex')">+</button></td></tr>
    <tr><th>–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç</th><td><span id="attrInt">0</span><button class="upgrade" onclick="upgrade('int')">+</button></td></tr>
    <tr><th>–ñ–∏–≤—É—á–µ—Å—Ç—å</th><td><span id="attrVit">0</span><button class="upgrade" onclick="upgrade('vit')">+</button></td></tr>
    <tr><th>–£–¥–∞—á–∞</th><td><span id="attrLuck">0</span><button class="upgrade" onclick="upgrade('luck')">+</button></td></tr>
  </table>
  <button onclick="backToMenu()">–ù–∞–∑–∞–¥</button>
</div>
<div id="endScreen">
  <h2 id="endMessage">–ü–æ–±–µ–¥–∞!</h2>
  <button onclick="showMainMenu()">–í –º–µ–Ω—é</button>
</div>
<div id="enemyStats">
  <div>üëπ –í—Ä–∞–≥ HP: <span id="enemyHpEl">100</span></div>
  <div>üõ° <span id="enemyShieldEl">100</span></div>
  <div>üîÆ <span id="enemyManaEl">0</span></div>
</div>
<div id="stats">
  <div>‚ù§Ô∏è –í–∞—à–µ HP: <span id="hpEl">200</span></div>
  <div>üõ° <span id="shieldEl">100</span></div>
  <div>üîÆ <span id="manaEl">0</span></div>
</div>
<div id="timerBarContainer"><div id="timerBar"></div></div>
<div id="battleLog"></div>
<button id="lightningBtn" onclick="useLightning()">‚ö° –ú–æ–ª–Ω–∏—è (20 –º–∞–Ω—ã)</button>
<div id="board"></div>

<script>
let isPlayerTurn = true;
let hp = 200, shield = 100, mana = 0, enemyHp = 100, enemyShield = 100, enemyMana = 0;
let playerName = "–ò–≥—Ä–æ–∫", turnTimer, lightningUsed = false;
let xp = 0, skillPoints = 0;
let attributes = {str:0, dex:0, int:0, vit:0, luck:0};
let comboAccumulator = {};
const colors = ['red', 'green', 'blue', 'purple', 'orange'];
const mainMenu = document.getElementById("mainMenu");
const charMenu = document.getElementById("charMenu");
const endScreen = document.getElementById("endScreen");
const endMessage = document.getElementById("endMessage");
const xpEl = document.getElementById("xpEl");
const skillPointsEl = document.getElementById("skillPointsEl");
const attrEls = {
  str: document.getElementById("attrStr"),
  dex: document.getElementById("attrDex"),
  int: document.getElementById("attrInt"),
  vit: document.getElementById("attrVit"),
  luck: document.getElementById("attrLuck")
};
const board = document.getElementById("board");
const hpEl = document.getElementById("hpEl");
const shieldEl = document.getElementById("shieldEl");
const manaEl = document.getElementById("manaEl");
const enemyHpEl = document.getElementById("enemyHpEl");
const enemyShieldEl = document.getElementById("enemyShieldEl");
const enemyManaEl = document.getElementById("enemyManaEl");
const timerBar = document.getElementById("timerBar");
const lightningBtn = document.getElementById("lightningBtn");
const battleLog = document.getElementById("battleLog");
let grid = [];

window.onload = () => { 
  mainMenu.style.display = "flex";
  charMenu.style.display = "none";
  endScreen.style.display = "none";
  updateCharacterUI();
};

function showMainMenu() {
  mainMenu.style.display = "flex";
  charMenu.style.display = "none";
  endScreen.style.display = "none";
  updateCharacterUI();
}
function showCharacterMenu() {
  mainMenu.style.display = "none";
  charMenu.style.display = "flex";
  updateCharacterUI();
}
function backToMenu() {
  charMenu.style.display = "none";
  mainMenu.style.display = "flex";
}
function updateCharacterUI() {
  xpEl.textContent = xp;
  skillPointsEl.textContent = skillPoints;
  for (let key in attributes) attrEls[key].textContent = attributes[key];
}
function upgrade(attr) {
  if (skillPoints > 0 && attributes[attr] < 10) {
    attributes[attr]++;
    skillPoints--;
    updateCharacterUI();
  }
}
function startGame() {
  hp = 200 + (attributes.vit * 10); 
  shield = 100; 
  mana = 0;
  enemyHp = 100 + Math.floor(xp/10); 
  enemyShield = 100; 
  enemyMana = 0;
  lightningUsed = false;
  updateStats();
  createGrid();
  endScreen.style.display = "none";
  mainMenu.style.display = "none";
  charMenu.style.display = "none";
  document.body.classList.remove("enemy-turn");
  isPlayerTurn = true;
  lightningBtn.style.display = "none";
  startTurn();
}
function updateStats() {
  hpEl.textContent = hp;
  shieldEl.textContent = shield;
  manaEl.textContent = mana;
  enemyHpEl.textContent = enemyHp;
  enemyShieldEl.textContent = enemyShield;
  enemyManaEl.textContent = enemyMana;
}
function createGrid() {
  board.innerHTML = "";
  grid = [];
  for (let i = 0; i < 36; i++) {
    const cell = document.createElement("div");
    cell.className = "cell " + colors[Math.floor(Math.random() * colors.length)];
    board.appendChild(cell);
    grid.push(cell);
  }
}
function index(r, c) { return r * 6 + c; }
function getColor(el) { return colors.find(c => el.classList.contains(c)); }

function startTurn() {
  isPlayerTurn = true;
  lightningUsed = false;
  comboAccumulator = { red: 0, green: 0, blue: 0, orange: 0, purple: 0, count: 0 };
  document.body.classList.remove("enemy-turn");
  board.style.pointerEvents = "auto";
  lightningBtn.style.display = mana >= 20 ? "inline-block" : "none";
  let time = 20;
  timerBar.style.width = "100%";
  clearInterval(turnTimer);
  turnTimer = setInterval(() => {
    time--;
    timerBar.style.width = (time * 5) + "%";
    if (time <= 0) {
      clearInterval(turnTimer);
      endTurn();
    }
  }, 1000);
}
function endTurn() {
  board.style.pointerEvents = "none";
  resolveCascade();
}
function resolveCascade() {
  const matches = checkMatches();
  if (matches.length === 0) {
    applyEffects();
    if (checkEnd()) return;
    isPlayerTurn ? setTimeout(monsterTurn, 800) : setTimeout(startTurn, 800);
    return;
  }
  matches.forEach(g => {
    const color = getColor(grid[g[0]]);
    comboAccumulator[color] = (comboAccumulator[color] || 0) + g.length;
    comboAccumulator.count += 1;
    g.forEach(i => grid[i].classList.add("highlight"));
  });
  setTimeout(() => {
    matches.flat().forEach(i => {
      grid[i].classList.remove("highlight");
      grid[i].classList.add("fade");
    });
    setTimeout(() => {
      matches.flat().forEach(i => grid[i].className = "cell");
      dropDown();
      setTimeout(resolveCascade, 600);
    }, 600);
  }, 1000);
}
function applyEffects() {
  const { red, green, blue, orange, purple, count } = comboAccumulator;
  let dmg = red >= 5 ? 20 : red >= 3 ? 10 : 0;
  let heal = green >= 5 ? 10 : green >= 3 ? 5 : 0;
  let def = blue >= 5 ? 10 : blue >= 3 ? 5 : 0;
  let critChance = orange + attributes.luck;
  let manaGain = purple >= 5 ? 20 : purple >= 3 ? 10 : 0;
  let comboBonus = count > 1 ? Math.round((count-1)*5) : 0;

  if (isPlayerTurn) {
    mana += manaGain;
    if (mana > 100) mana = 100;
  } else {
    enemyMana += manaGain;
    if (enemyMana > 100) enemyMana = 100;
  }
  let isCrit = Math.random() * 100 < critChance;
  dmg += Math.floor(dmg * (attributes.str || 0) / 100);

  if (comboBonus) {
    dmg = Math.floor(dmg * (1 + comboBonus/100));
    heal = Math.floor(heal * (1 + comboBonus/100));
    def = Math.floor(def * (1 + comboBonus/100));
  }

  let totalDmg = dmg + (isCrit ? dmg : 0);
  if (isPlayerTurn && lightningUsed) {
    totalDmg += 50 + Math.floor(50 * (attributes.int || 0) / 100);
  }

  if (isPlayerTurn) {
    let half = Math.floor(totalDmg / 2);
    if (enemyShield >= half) {
      enemyShield -= half;
      enemyHp -= (totalDmg - half);
    } else {
      let rem = half - enemyShield;
      enemyShield = 0;
      enemyHp -= (totalDmg - half + rem);
    }
    shield += def;
    if (shield > 100 + (attributes.vit * 5)) shield = 100 + (attributes.vit * 5);
    hp += heal;
    if (hp > 200 + (attributes.vit * 10)) hp = 200 + (attributes.vit * 10);
    if (heal > 0) float("+" + heal, hpEl, "#00ff00");
    if (def > 0) float("+" + def, shieldEl, "#3399ff");
    battleLog.innerHTML = `<span style="color:#66ff66">–ö–æ–º–±–æ √ó${count}${comboBonus?` (+${comboBonus}%)`:''}, –£—Ä–æ–Ω: ${dmg}${isCrit ? ' (–ö–†–ò–¢!)' : ''}${lightningUsed ? ', +–ú–æ–ª–Ω–∏—è' : ''}</span>`;
  } else {
    let half = Math.floor(totalDmg / 2);
    if (shield >= half) {
      shield -= half;
      hp -= (totalDmg - half);
    } else {
      let rem = half - shield;
      shield = 0;
      hp -= (totalDmg - half + rem);
    }
    enemyShield += def;
    enemyHp += heal;
    if (enemyHp > 100 + Math.floor(xp/10)) enemyHp = 100 + Math.floor(xp/10);
    if (enemyShield > 100) enemyShield =
