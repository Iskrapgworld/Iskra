<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>üî• –ò–°–ö–†–ê: –ë–∏—Ç–≤–∞</title>
  <style>
    body {
      margin: 0;
      background-color: #111;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
    }
    h1 {
      color: #ffa500;
      margin: 10px 0;
    }
    #topBar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 10px;
      font-size: 14px;
    }
    #timerBarContainer {
      flex-grow: 1;
      height: 10px;
      margin: 0 10px;
      background: #444;
      border-radius: 5px;
      overflow: hidden;
    }
    #timerBar {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, #33ff33, #ffff00);
      transition: width 1s linear;
    }
    #battleLog {
      margin: 5px;
      padding: 4px;
      font-size: 14px;
      min-height: 30px;
    }
    #board {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 4px;
      width: 360px;
      margin: 10px auto 0 auto;
      transition: opacity 0.3s ease;
    }
    .cell {
      width: 58px;
      height: 58px;
      border-radius: 50%;
      transition: transform 0.3s ease, opacity 1s ease;
    }
    .red    { background: radial-gradient(circle, #ff4d4d, #990000); }
    .green  { background: radial-gradient(circle, #66ff66, #006600); }
    .blue   { background: radial-gradient(circle, #66ccff, #003366); }
    .purple { background: radial-gradient(circle, #dca0ff, #440066); }
    .orange { background: radial-gradient(circle, #cc9955, #cc6600); }
    .highlight { box-shadow: 0 0 10px 4px #ffffff88; }
    .fade { opacity: 0; }
    .enemy-turn #board {
      pointer-events: none;
      opacity: 0.2;
    }
    #overlay, #endScreen {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 999;
    }
    .floatText {
      position: absolute;
      font-size: 14px;
      font-weight: bold;
      pointer-events: none;
      animation: floatUp 3s ease forwards;
    }
    @keyframes floatUp {
      from { opacity: 1; transform: translateY(0); }
      to   { opacity: 0; transform: translateY(-30px); }
    }
    #overlay input {
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: none;
      margin-top: 10px;
    }
    button {
      padding: 10px 20px;
      margin-top: 10px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      background: #6622cc;
      color: white;
    }
    #lightningBtn {
      display: none;
      padding: 10px 20px;
      margin: 10px auto;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      background: #ffcc00;
      color: #000;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>üî• –ò–°–ö–†–ê: –ë–∏—Ç–≤–∞ üî•</h1>
  <div id="topBar">
    <div>–í—ã:<br>‚ù§Ô∏è <span id="hp">200</span> <span id="healText"></span><br>üõ° <span id="shield">100</span> <span id="defText"></span><br>üîÆ <span id="mana">0</span></div>
    <div id="timerBarContainer"><div id="timerBar"></div></div>
    <div>–ú–æ–Ω—Å—Ç—Ä:<br>üíÄ <span id="enemyHp">100</span> <span id="enemyHealText"></span><br>üõ° <span id="enemyShield">100</span> <span id="enemyDefText"></span><br>üîÆ <span id="enemyMana">0</span></div>
  </div>
  <div id="battleLog">–ö–æ–º–±–æ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</div>
  <div id="board"></div>
  <button id="lightningBtn" onclick="useLightning()">‚ö° –ú–æ–ª–Ω–∏—è (20 –º–∞–Ω–Ω—ã)</button>
  <div id="overlay">
    <h2>–í–≤–µ–¥–∏—Ç–µ –∏–º—è:</h2>
    <input id="nickname" placeholder="–ò–º—è –∏–≥—Ä–æ–∫–∞">
    <button onclick="startGame()">–í –±–æ–π!</button>
  </div>
  <div id="endScreen" style="display:none;">
    <h2 id="endMessage">–ü–æ–±–µ–¥–∞!</h2>
    <button onclick="startGame()">–°—ã–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
  </div>
  <script>
let boardSize = 6;
let colors = ['red', 'green', 'blue', 'orange', 'purple'];
let board = [];
let selected = null;
let isPlayerTurn = true;
let player = { hp: 200, shield: 100, mana: 0, crit: 0 };
let enemy  = { hp: 100, shield: 100, mana: 0, crit: 0 };
let timer, turnTime = 20, currentTimer = turnTime;
let playerName = '';

function startGame() {
  playerName = document.getElementById('nickname').value || '–ò–≥—Ä–æ–∫';
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('endScreen').style.display = 'none';
  player.hp = 200; player.shield = 100; player.mana = 0;
  enemy.hp = 100; enemy.shield = 100; enemy.mana = 0;
  updateUI();
  generateBoard();
  while (checkMatches().length > 0) generateBoard();
  startTimer();
}

function updateUI() {
  document.getElementById('hp').textContent = player.hp;
  document.getElementById('shield').textContent = player.shield;
  document.getElementById('mana').textContent = player.mana;
  document.getElementById('enemyHp').textContent = enemy.hp;
  document.getElementById('enemyShield').textContent = enemy.shield;
  document.getElementById('enemyMana').textContent = enemy.mana;
  document.getElementById('battleLog').textContent = '';
  document.getElementById('healText').textContent = '';
  document.getElementById('defText').textContent = '';
  document.getElementById('enemyHealText').textContent = '';
  document.getElementById('enemyDefText').textContent = '';
  document.getElementById('lightningBtn').style.display = isPlayerTurn && player.mana >= 20 ? 'inline-block' : 'none';
}

function generateBoard() {
  const boardDiv = document.getElementById('board');
  boardDiv.innerHTML = '';
  board = [];
  for (let i = 0; i < boardSize; i++) {
    board[i] = [];
    for (let j = 0; j < boardSize; j++) {
      const color = colors[Math.floor(Math.random() * colors.length)];
      board[i][j] = color;
      const cell = document.createElement('div');
      cell.className = 'cell ' + color;
      cell.dataset.row = i;
      cell.dataset.col = j;
      cell.addEventListener('click', onClick);
      boardDiv.appendChild(cell);
    }
  }
  positionBoard();
}

function positionBoard() {
  const boardDiv = document.getElementById('board');
  boardDiv.style.marginBottom = '10px';
}

function onClick(e) {
  if (!isPlayerTurn) return;
  const row = parseInt(e.target.dataset.row);
  const col = parseInt(e.target.dataset.col);
  if (!selected) {
    selected = { row, col };
    e.target.style.transform = 'scale(1.2)';
  } else {
    swapAndCheck(selected, { row, col });
    resetSelection();
  }
}

function resetSelection() {
  document.querySelectorAll('.cell').forEach(cell => cell.style.transform = '');
  selected = null;
}

function swapAndCheck(first, second) {
  const dx = Math.abs(first.row - second.row);
  const dy = Math.abs(first.col - second.col);
  if (dx + dy !== 1) return;
  [board[first.row][first.col], board[second.row][second.col]] = [board[second.row][second.col], board[first.row][first.col]];
  renderBoard();
  resolveTurn();
}

function renderBoard() {
  const cells = document.querySelectorAll('.cell');
  cells.forEach(cell => {
    const i = parseInt(cell.dataset.row);
    const j = parseInt(cell.dataset.col);
    cell.className = 'cell ' + board[i][j];
  });
}

function startTimer() {
  clearInterval(timer);
  currentTimer = turnTime;
  document.getElementById('timerBar').style.width = '100%';
  timer = setInterval(() => {
    currentTimer--;
    document.getElementById('timerBar').style.width = `${(currentTimer / turnTime) * 100}%`;
    if (currentTimer <= 0) {
      clearInterval(timer);
      resolveTurn();
    }
  }, 1000);
}

function resolveTurn() {
  clearInterval(timer);
  isPlayerTurn ? applyEffects(player, enemy, true) : applyEffects(enemy, player, false);
}

function applyEffects(active, target, isPlayer) {
  const matches = checkMatches();
  let totalDamage = 0, totalHeal = 0, totalShield = 0, totalCrit = 0, totalMana = 0;
  matches.forEach(match => {
    let color = board[match[0][0]][match[0][1]];
    let length = match.length;
    if (color === 'red') totalDamage += length >= 5 ? 20 : 10;
    if (color === 'green') totalHeal += length >= 5 ? 10 : 5;
    if (color === 'blue') totalShield += length >= 5 ? 10 : 5;
    if (color === 'orange') totalCrit += length;
    if (color === 'purple') totalMana += length >= 5 ? 20 : 10;
  });

  active.mana += totalMana;
  active.crit += totalCrit;
  if (totalHeal) showFloatText(`+${totalHeal}`, isPlayer ? 'healText' : 'enemyHealText');
  if (totalShield) showFloatText(`+${totalShield}`, isPlayer ? 'defText' : 'enemyDefText');
  active.hp += totalHeal;
  active.shield += totalShield;

  let critChance = Math.min(active.crit, 100);
  let isCrit = Math.random() * 100 < critChance;
  if (isCrit) totalDamage *= 2;

  if (totalDamage > 0) {
    let shieldAbsorb = Math.min(target.shield, totalDamage / 2);
    target.shield -= shieldAbsorb;
    target.hp -= totalDamage - shieldAbsorb;
  }

  updateUI();
  renderBoard();

  setTimeout(() => {
    removeMatches(matches);
    fillBoard();
    updateUI();
    if (target.hp <= 0) return endGame(true);
    if (active.hp <= 0) return endGame(false);
    isPlayerTurn = !isPlayerTurn;
    document.body.classList.toggle('enemy-turn', !isPlayerTurn);
    startTimer();
  }, 1000);
}

function checkMatches() {
  let matches = [];
  for (let i = 0; i < boardSize; i++) {
    for (let j = 0; j < boardSize - 2; j++) {
      if (board[i][j] === board[i][j + 1] && board[i][j] === board[i][j + 2])
        matches.push([[i, j], [i, j + 1], [i, j + 2]]);
    }
  }
  for (let j = 0; j < boardSize; j++) {
    for (let i = 0; i < boardSize - 2; i++) {
      if (board[i][j] === board[i + 1][j] && board[i][j] === board[i + 2][j])
        matches.push([[i, j], [i + 1, j], [i + 2, j]]);
    }
  }
  return matches;
}

function removeMatches(matches) {
  matches.forEach(match => match.forEach(([i, j]) => board[i][j] = null));
  renderBoard();
}

function fillBoard() {
  for (let j = 0; j < boardSize; j++) {
    let col = board.map(row => row[j]).filter(c => c !== null);
    while (col.length < boardSize) col.unshift(colors[Math.floor(Math.random() * colors.length)]);
    for (let i = 0; i < boardSize; i++) board[i][j] = col[i];
  }
  renderBoard();
}

function showFloatText(text, elementId) {
  document.getElementById(elementId).textContent = text;
  setTimeout(() => { document.getElementById(elementId).textContent = ''; }, 3000);
}

function endGame(win) {
  document.getElementById('endScreen').style.display = 'flex';
  document.getElementById('endMessage').textContent = win ? '–ü–æ–±–µ–¥–∞!' : '–ü–æ—Ä–∞–∂–µ–Ω–∏–µ!';
}

function useLightning() {
  if (!isPlayerTurn || player.mana < 20) return;
  player.mana -= 20;
  let damage = 50;
  let absorb = Math.min(enemy.shield, damage / 2);
  enemy.shield -= absorb;
  enemy.hp -= damage - absorb;
  updateUI();
}
</script>
</body>
</html>
